name: C/C++ CI and Release

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main", "master" ]

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write

jobs:
  # å¸¸è§„CIæ„å»ºå’Œæµ‹è¯•
  build:
    runs-on: ubuntu-latest
    # ä»…åœ¨étagæ¨é€æ—¶è¿è¡Œ
    if: github.ref_type != 'tag'

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Build native
      run: |
        make native
        ls -la build/

    - name: Check build result
      run: |
        file build/usbctl
        ./build/usbctl --help || true

  # å‘å¸ƒæ„å»º - ä»…åœ¨æ¨é€tagæ—¶è¿è¡Œ
  release:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'

    steps:
    - uses: actions/checkout@v4

    - name: Install all cross-compilation dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

        # å…ˆå°è¯•å®‰è£…åŸºç¡€çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆä¸åŒ…å«å†²çªçš„åŒ…ï¼‰
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabihf \
          gcc-powerpc64le-linux-gnu \
          gcc-riscv64-linux-gnu \
          gcc-s390x-linux-gnu || true

        # å•ç‹¬å®‰è£…å¯èƒ½å†²çªçš„ MIPS å·¥å…·é“¾
        sudo apt-get install -y \
          gcc-mips-linux-gnu \
          gcc-mipsel-linux-gnu \
          gcc-mips64-linux-gnuabi64 \
          gcc-mips64el-linux-gnuabi64 || true

        # å®‰è£… MinGW ç”¨äº Windows äº¤å‰ç¼–è¯‘
        sudo apt-get install -y \
          gcc-mingw-w64-x86-64 \
          gcc-mingw-w64-i686 || true

        # å¦‚æœä¸Šè¿°å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨äº¤å‰ç¼–è¯‘åŒ…
        if ! command -v aarch64-linux-gnu-gcc >/dev/null 2>&1; then
          sudo apt-get install -y crossbuild-essential-arm64 || true
        fi

        if ! command -v arm-linux-gnueabihf-gcc >/dev/null 2>&1; then
          sudo apt-get install -y crossbuild-essential-armhf || true
        fi

    - name: Check available cross-compilers
      run: |
        make check-deps

    - name: Build all targets and create distribution
      run: |
        # ä½¿ç”¨ Makefile çš„å®Œæ•´å‘å¸ƒæµç¨‹
        make dist
        make checksums
        make package
        
        # æ˜¾ç¤ºæ„å»ºç»“æœ
        echo "=== Built binaries ==="
        ls -la build/
        
        echo "=== Distribution files ==="
        ls -la dist/
        
        echo "=== Release packages ==="
        ls -la dist/*.tar.gz dist/*.zip 2>/dev/null || true
        
        echo "=== Checksums ==="
        cat dist/SHA256SUMS

    - name: Upload individual binaries as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: build/usbctl-*

    - name: Upload distribution files as artifacts  
      uses: actions/upload-artifact@v4
      with:
        name: distribution
        path: dist/*

  # åˆ›å»ºGitHub Release
  create-release:
    needs: release
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        mkdir -p release-files
        
        # å¤åˆ¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
        find artifacts/binaries -name "usbctl-*" -type f -exec cp {} release-files/ \; 2>/dev/null || true
        
        # å¤åˆ¶åˆ†å‘åŒ…
        find artifacts/distribution -name "*.tar.gz" -o -name "*.zip" -exec cp {} release-files/ \; 2>/dev/null || true
        
        # å¤åˆ¶æ ¡éªŒæ–‡ä»¶
        cp artifacts/distribution/SHA256SUMS release-files/ 2>/dev/null || true
        
        # å¤åˆ¶å®‰è£…è„šæœ¬å’Œæ–‡æ¡£
        cp install-service.sh release-files/ 2>/dev/null || true
        cp README.md release-files/ 2>/dev/null || true
        cp LICENSE release-files/ 2>/dev/null || true
        
        echo "=== Release files ==="
        ls -la release-files/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: usbctl ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ‰ USBé€ä¼ å·¥å…· ${{ github.ref_name }} å‘å¸ƒ

          ### ğŸ“¦ æ”¯æŒçš„å¹³å°

          **Linux æ¶æ„æ”¯æŒï¼š**
          
          | æ¶æ„ | æ–‡ä»¶å | é€‚ç”¨è®¾å¤‡ |
          |------|--------|----------|
          | x86_64 | `usbctl-linux-x86_64` | PCæœåŠ¡å™¨ã€æ™®é€šç”µè„‘ |
          | ARM64 | `usbctl-linux-arm64` | æ ‘è“æ´¾4ã€ARM64æœåŠ¡å™¨ |
          | ARMv7 | `usbctl-linux-armv7` | æ ‘è“æ´¾3ã€ARM32è®¾å¤‡ |
          | i386 | `usbctl-linux-i386` | 32ä½x86ç³»ç»Ÿ |
          | MIPS | `usbctl-linux-mips` | è·¯ç”±å™¨ã€åµŒå…¥å¼è®¾å¤‡ |
          | MIPS64 | `usbctl-linux-mips64` | 64ä½MIPSè®¾å¤‡ |
          | PowerPC64LE | `usbctl-linux-ppc64le` | IBM PoweræœåŠ¡å™¨ |
          | RISC-V64 | `usbctl-linux-riscv64` | RISC-Vå¼€å‘æ¿ |
          | s390x | `usbctl-linux-s390x` | IBM Zç³»åˆ—å¤§å‹æœº |

          **Windows æ”¯æŒï¼š**
          
          | æ¶æ„ | æ–‡ä»¶å | é€‚ç”¨ç³»ç»Ÿ |
          |------|--------|----------|
          | x86_64 | `usbctl-windows-x86_64.exe` | 64ä½Windows |
          | i386 | `usbctl-windows-i386.exe` | 32ä½Windows |

          **æ‰“åŒ…ä¸‹è½½ï¼š**
          
          - `usbctl-${{ github.ref_name }}-linux.tar.gz` - æ‰€æœ‰Linuxç‰ˆæœ¬æ‰“åŒ…
          - `usbctl-${{ github.ref_name }}-windows.zip` - æ‰€æœ‰Windowsç‰ˆæœ¬æ‰“åŒ…
          - `SHA256SUMS` - æ ¡éªŒå’Œæ–‡ä»¶

          ### ğŸš€ å¿«é€Ÿå®‰è£…

          #### æ–¹æ³•1ï¼šè‡ªåŠ¨å®‰è£…ï¼ˆæ¨è - ä»…Linuxï¼‰
          
          ```bash
          # 1. ä¸‹è½½å¯¹åº”æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œå®‰è£…è„šæœ¬
          # æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©ï¼Œä¾‹å¦‚ ARM64:
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/usbctl-linux-arm64
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/install-service.sh
          
          # 2. å‡†å¤‡å®‰è£…
          mkdir -p build
          mv usbctl-linux-arm64 build/usbctl  # æ ¹æ®æ‚¨çš„æ¶æ„è°ƒæ•´æ–‡ä»¶å
          chmod +x build/usbctl
          chmod +x install-service.sh
          
          # 3. ä¸€é”®å®‰è£…æœåŠ¡
          sudo ./install-service.sh install
          ```

          #### æ–¹æ³•2ï¼šä½¿ç”¨æ‰“åŒ…æ–‡ä»¶

          ```bash
          # ä¸‹è½½Linuxå®Œæ•´åŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/usbctl-${{ github.ref_name }}-linux.tar.gz
          tar -xzf usbctl-${{ github.ref_name }}-linux.tar.gz
          
          # é€‰æ‹©å¯¹åº”æ¶æ„çš„æ–‡ä»¶è¿›è¡Œå®‰è£…
          chmod +x usbctl-linux-x86_64  # ç¤ºä¾‹ï¼šx86_64æ¶æ„
          sudo cp usbctl-linux-x86_64 /usr/local/bin/usbctl
          ```

          #### æ–¹æ³•3ï¼šWindows ä½¿ç”¨

          ```cmd
          # ä¸‹è½½ Windows ç‰ˆæœ¬
          # ä¸‹è½½ usbctl-windows-x86_64.exe
          # åŒå‡»è¿è¡Œæˆ–åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨
          usbctl-windows-x86_64.exe --help
          ```

          ### ğŸ’¡ åŠŸèƒ½ç‰¹æ€§

          - **ğŸ”Œ USBè®¾å¤‡ç½‘ç»œé€ä¼ **ï¼šè®©è¿œç¨‹è®¾å¤‡è®¿é—®æœ¬åœ°USBè®¾å¤‡
          - **ğŸ–±ï¸ æ— çº¿åŒ–æœ‰çº¿è®¾å¤‡**ï¼šå°†å¤æ‚çš„æœ‰çº¿é”®é¼ æ”¹ä¸ºæ— çº¿ä½¿ç”¨  
          - **ğŸ”§ åµŒå…¥å¼å¼€å‘**ï¼šåœ¨å¼€å‘æ¿ä¸Šé€ä¼ USBè°ƒè¯•è®¾å¤‡
          - **ğŸ  æ™ºèƒ½å®¶å±…**ï¼šæ ‘è“æ´¾ä½œä¸ºUSBè®¾å¤‡æœåŠ¡å™¨
          - **ğŸ“± Webç®¡ç†ç•Œé¢**ï¼šé€šè¿‡æµè§ˆå™¨ç®¡ç†USBè®¾å¤‡
          - **ğŸŒ è·¨å¹³å°æ”¯æŒ**ï¼šæ”¯æŒå¤šç§CPUæ¶æ„å’Œæ“ä½œç³»ç»Ÿ

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚

          **Linuxç³»ç»Ÿï¼š**
          - å†…æ ¸æ”¯æŒ usbip æ¨¡å—
          - ç®¡ç†å‘˜æƒé™
          - ç½‘ç»œè¿æ¥

          **Windowsç³»ç»Ÿï¼š**
          - Windows 7 åŠä»¥ä¸Šç‰ˆæœ¬
          - ç®¡ç†å‘˜æƒé™ï¼ˆè®¿é—®USBè®¾å¤‡ï¼‰

          ### ğŸ”§ ä¾èµ–å®‰è£…ï¼ˆLinuxï¼‰

          è‡ªåŠ¨å®‰è£…è„šæœ¬ä¼šå¤„ç†æ‰€æœ‰ä¾èµ–ï¼Œå¦‚éœ€æ‰‹åŠ¨å®‰è£…ï¼š

          ```bash
          # Ubuntu/Debian
          sudo apt-get update
          sudo apt-get install usbip linux-tools-generic
          
          # åŠ è½½å†…æ ¸æ¨¡å—
          sudo modprobe usbip-host
          ```

          ### ğŸ” æ–‡ä»¶æ ¡éªŒ

          æ‰€æœ‰æ–‡ä»¶çš„SHA256æ ¡éªŒå’Œè¯·å‚è€ƒ `SHA256SUMS` æ–‡ä»¶ï¼š

          ```bash
          # æ ¡éªŒä¸‹è½½çš„æ–‡ä»¶
          sha256sum -c SHA256SUMS
          ```

          ### ğŸŒ ä½¿ç”¨è¯´æ˜

          å®‰è£…å®Œæˆåï¼Œè®¿é—® Web ç®¡ç†ç•Œé¢ï¼š
          ```
          http://YOUR_DEVICE_IP:11980
          ```

          ### ğŸ“š ç›¸å…³æ–‡æ¡£

          - [ğŸ“– è¯¦ç»†æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          - [ğŸ’¬ è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions)

          ### âš ï¸ æ³¨æ„äº‹é¡¹

          - Linuxé¦–æ¬¡ä½¿ç”¨éœ€è¦ç®¡ç†å‘˜æƒé™å®‰è£… usbip å·¥å…·
          - ç¡®ä¿é˜²ç«å¢™å¼€æ”¾ 3240 å’Œ 11980 ç«¯å£
          - æŸäº›USBè®¾å¤‡å¯èƒ½éœ€è¦ç‰¹å®šçš„å†…æ ¸æ¨¡å—
          - Windowsç‰ˆæœ¬éœ€è¦å®‰è£…å¯¹åº”çš„USBé©±åŠ¨

          ### ğŸ™ è‡´è°¢

          æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œæµ‹è¯•ç”¨æˆ·çš„æ”¯æŒï¼ç‰¹åˆ«æ„Ÿè°¢åµŒå…¥å¼å¼€å‘ç¤¾åŒºçš„åé¦ˆã€‚

        files: release-files/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}