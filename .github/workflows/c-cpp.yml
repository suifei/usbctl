name: C/C++ CI and Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  # å½“æ¨é€tagæ—¶è§¦å‘å‘å¸ƒ
  push:
    tags:
      - 'v*'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write

jobs:
  # å¸¸è§„CIæ„å»ºå’Œæµ‹è¯•
  build:
    runs-on: ubuntu-latest
    # ä»…åœ¨étagæ¨é€æ—¶è¿è¡Œ
    if: github.ref_type != 'tag'

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Build native
      run: |
        make native
        ls -la build/

    - name: Check build result
      run: |
        file build/usbctl
        ./build/usbctl --help || true

  # å‘å¸ƒæ„å»º - ä»…åœ¨æ¨é€tagæ—¶è¿è¡Œ
  release:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    strategy:
      matrix:
        include:
          # Linux x86_64
          - target: linux-x86_64
            cc: x86_64-linux-gnu-gcc
            artifact_name: usbctl-linux-x86_64
            
          # Linux ARM64 (æ ‘è“æ´¾4ç­‰)
          - target: linux-arm64
            cc: aarch64-linux-gnu-gcc
            artifact_name: usbctl-linux-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
        # å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        sudo apt-get install -y gcc-aarch64-linux-gnu gcc-multilib

    - name: Check cross-compiler
      run: |
        command -v ${{ matrix.cc }} && echo "âœ“ ${{ matrix.cc }} found" || echo "âœ— ${{ matrix.cc }} not found"

    - name: Build ${{ matrix.target }}
      run: |
        # ä½¿ç”¨ Makefile ä¸­å®šä¹‰çš„ç›®æ ‡æ„å»º
        make ${{ matrix.target }}
        
        # éªŒè¯æ„å»ºç»“æœ
        ls -la build/
        file build/${{ matrix.artifact_name }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: build/${{ matrix.artifact_name }}

  # åˆ›å»ºGitHub Release
  create-release:
    needs: release
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        mkdir -p release-files
        find artifacts -name "usbctl-*" -type f -exec cp {} release-files/ \;
        ls -la release-files/
        
        # å¤åˆ¶å®‰è£…è„šæœ¬
        cp install-service.sh release-files/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: usbctl ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ‰ USBé€ä¼ å·¥å…· ${{ github.ref_name }} å‘å¸ƒ

          ### ğŸ“¦ æ”¯æŒçš„å¹³å°

          | å¹³å° | æ¶æ„ | æ–‡ä»¶å | é€‚ç”¨è®¾å¤‡ |
          |------|------|--------|----------|
          | ğŸ§ Linux | x86_64 | `usbctl-linux-x86_64` | PCæœåŠ¡å™¨ã€æ™®é€šç”µè„‘ |
          | ğŸ§ Linux | ARM64 | `usbctl-linux-arm64` | æ ‘è“æ´¾4ã€ARM64æœåŠ¡å™¨ |

          ### ğŸš€ å¿«é€Ÿå®‰è£…

          #### æ–¹æ³•1ï¼šè‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰
          
          ```bash
          # 1. ä¸‹è½½å¹¶è§£å‹å‘å¸ƒåŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/usbctl-linux-arm64
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/install-service.sh
          
          # 2. å‡†å¤‡å®‰è£…
          mkdir -p build
          mv usbctl-linux-arm64 build/usbctl  # æ ¹æ®æ‚¨çš„æ¶æ„é€‰æ‹©å¯¹åº”æ–‡ä»¶
          chmod +x build/usbctl
          chmod +x install-service.sh
          
          # 3. å®‰è£…æœåŠ¡
          sudo ./install-service.sh install
          ```

          #### æ–¹æ³•2ï¼šæ‰‹åŠ¨å®‰è£…

          ```bash
          # 1. ä¸‹è½½å¯¹åº”æ¶æ„çš„æ–‡ä»¶
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/usbctl-linux-x86_64
          
          # 2. æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x usbctl-linux-x86_64
          
          # 3. å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„
          sudo cp usbctl-linux-x86_64 /usr/local/bin/usbctl
          
          # 4. è¿è¡Œç¨‹åº
          usbctl --help
          ```

          ### ğŸ’¡ åŠŸèƒ½ç‰¹æ€§

          - **ğŸ”Œ USBè®¾å¤‡ç½‘ç»œé€ä¼ **ï¼šè®©è¿œç¨‹è®¾å¤‡è®¿é—®æœ¬åœ°USBè®¾å¤‡
          - **ğŸ–±ï¸ æ— çº¿åŒ–æœ‰çº¿è®¾å¤‡**ï¼šå°†å¤æ‚çš„æœ‰çº¿é”®é¼ æ”¹ä¸ºæ— çº¿ä½¿ç”¨  
          - **ğŸ”§ åµŒå…¥å¼å¼€å‘**ï¼šåœ¨å¼€å‘æ¿ä¸Šé€ä¼ USBè°ƒè¯•è®¾å¤‡
          - **ğŸ  æ™ºèƒ½å®¶å±…**ï¼šæ ‘è“æ´¾ä½œä¸ºUSBè®¾å¤‡æœåŠ¡å™¨
          - **ğŸ“± Webç®¡ç†ç•Œé¢**ï¼šé€šè¿‡æµè§ˆå™¨ç®¡ç†USBè®¾å¤‡

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚

          **æœ€ä½è¦æ±‚ï¼š**
          - Linux ç³»ç»Ÿï¼ˆæ¨è Ubuntu 18.04+ æˆ– Debian 10+ï¼‰
          - å†…æ ¸æ”¯æŒ usbip æ¨¡å—
          - ç®¡ç†å‘˜æƒé™

          **æ¨èç¯å¢ƒï¼š**
          - æ ‘è“æ´¾ 4B (ARM64) æˆ– PC (x86_64)
          - 2GB+ å†…å­˜
          - ç½‘ç»œè¿æ¥

          ### ğŸ”§ ä¾èµ–å®‰è£…

          è‡ªåŠ¨å®‰è£…è„šæœ¬ä¼šå¤„ç†æ‰€æœ‰ä¾èµ–ï¼Œå¦‚éœ€æ‰‹åŠ¨å®‰è£…ï¼š

          ```bash
          # Ubuntu/Debian
          sudo apt-get update
          sudo apt-get install usbip linux-tools-generic
          
          # åŠ è½½å†…æ ¸æ¨¡å—
          sudo modprobe usbip-host
          ```

          ### ğŸŒ ä½¿ç”¨è¯´æ˜

          å®‰è£…å®Œæˆåï¼Œè®¿é—® Web ç®¡ç†ç•Œé¢ï¼š
          ```
          http://YOUR_PI_IP:11980
          ```

          ### ğŸ“š ç›¸å…³æ–‡æ¡£

          - [ğŸ“– è¯¦ç»†æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          - [ğŸ’¬ è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions)

          ### ğŸ”„ æ›´æ–°è¯´æ˜

          å®Œæ•´çš„æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜ã€‚

          ### âš ï¸ æ³¨æ„äº‹é¡¹

          - é¦–æ¬¡ä½¿ç”¨éœ€è¦ç®¡ç†å‘˜æƒé™å®‰è£… usbip å·¥å…·
          - ç¡®ä¿é˜²ç«å¢™å¼€æ”¾ 3240 å’Œ 11980 ç«¯å£
          - æŸäº›USBè®¾å¤‡å¯èƒ½éœ€è¦ç‰¹å®šçš„å†…æ ¸æ¨¡å—

          ### ğŸ™ è‡´è°¢

          æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œæµ‹è¯•ç”¨æˆ·çš„æ”¯æŒï¼ç‰¹åˆ«æ„Ÿè°¢æ ‘è“æ´¾ç¤¾åŒºçš„åé¦ˆã€‚

        files: release-files/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}