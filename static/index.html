<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>usbctl - USB/IP Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font: 14px/1.4 system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            color: #333;
            padding: 10px;
            padding-bottom: 220px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: #fff;
            border-radius: 8px;
        }
        h1 { font-size: 24px; margin: 5px 0; }
        .controls { text-align: center; margin-bottom: 15px; }
        .lang-btn {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
            font-size: 11px;
        }
        .lang-btn.active { background: #155724; }
        .main-content { margin-bottom: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }
        th {
            background: #007bff;
            color: #fff;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:hover { background: #f8f9fa; }
        .status {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        .bound { background: #d4edda; color: #155724; }
        .unbound { background: #f8d7da; color: #721c24; }
        button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .btn-bind { background: #28a745; color: #fff; }
        .btn-unbind { background: #dc3545; color: #fff; }
        .btn-bind:hover { background: #218838; }
        .btn-unbind:hover { background: #c82333; }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            background: #17a2b8;
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            color: #6c757d;
            background: rgba(248,249,250,0.98);
            padding: 8px 15px;
            border-top: 1px solid #dee2e6;
            backdrop-filter: blur(10px);
            z-index: 999;
        }
        .footer a { color: #007bff; text-decoration: none; }
        .log-container {
            position: fixed;
            bottom: 40px;
            left: 0;
            right: 0;
            height: 150px;
            background: #fff;
            border-top: 2px solid #007bff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 998;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .log-title { font-weight: 600; color: #333; font-size: 13px; }
        .clear-log-btn {
            background: #6c757d;
            color: #fff;
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .clear-log-btn:hover { background: #5a6268; }
        .log-content {
            height: calc(150px - 40px);
            overflow-y: auto;
            padding: 8px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.3;
        }
        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
            border-left: 3px solid transparent;
            padding-left: 8px;
        }
        .log-success { color: #155724; border-left-color: #28a745; background: #d4edda; }
        .log-error { color: #721c24; border-left-color: #dc3545; background: #f8d7da; }
        .log-info { color: #0c5460; border-left-color: #17a2b8; background: #d1ecf1; }
        .log-timestamp { color: #6c757d; font-size: 10px; }
        @media(max-width:768px) {
            body { padding: 5px; padding-bottom: 200px; }
            h1 { font-size: 20px; }
            th, td { padding: 6px 8px; font-size: 12px; }
            button { padding: 3px 6px; font-size: 10px; }
            .controls { margin-bottom: 10px; }
            .footer { padding: 6px 10px; font-size: 10px; }
            .log-container { height: 130px; bottom: 35px; }
            .log-content { height: calc(130px - 35px); font-size: 11px; }
            .log-header { padding: 6px 12px; }
            .log-title { font-size: 12px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>USB/IP Manager</h1>
    </header>

    <div class="controls">
        <button class="lang-btn active" data-lang="en" onclick="setLang('en')">English</button>
        <button class="lang-btn" data-lang="zh" onclick="setLang('zh')">中文</button>
    </div>

    <div id="status">Connecting...</div>

    <div class="main-content">
        <table>
            <thead>
                <tr>
                    <th>Device Info</th>
                    <th>Bus ID</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="log-container">
        <div class="log-header">
            <span class="log-title">Operation Log</span>
            <button class="clear-log-btn" onclick="clearLog()">Clear</button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <div class="footer">
        Powered by <a href="https://github.com/suifei/usbctl" target="_blank">usbctl v1.0.0</a> | 
        <a href="https://github.com/suifei" target="_blank">github.com/suifei</a>
    </div>

    <script>
        let eventSource, devices = [], lang = 'en', logEntries = [];

        const i18n = {
            'en': {
                'title': 'USB/IP Manager',
                'device': 'Device Info',
                'busid': 'Bus ID',
                'status': 'Status',
                'action': 'Action',
                'bound': 'Bound',
                'unbound': 'Unbound',
                'bind': 'Bind',
                'unbind': 'Unbind',
                'connected': 'Connected',
                'disconnected': 'Disconnected',
                'log_title': 'Operation Log',
                'clear': 'Clear',
                'bind_success': 'Device {busid} bound successfully',
                'unbind_success': 'Device {busid} unbound successfully',
                'bind_error': 'Error binding device {busid}: {error}',
                'unbind_error': 'Error unbinding device {busid}: {error}'
            },
            'zh': {
                'title': 'USB/IP 管理器',
                'device': '设备信息',
                'busid': '总线ID',
                'status': '状态',
                'action': '操作',
                'bound': '已绑定',
                'unbound': '未绑定',
                'bind': '绑定',
                'unbind': '解绑',
                'connected': '已连接',
                'disconnected': '已断开',
                'log_title': '操作日志',
                'clear': '清除',
                'bind_success': '设备 {busid} 绑定成功',
                'unbind_success': '设备 {busid} 解绑成功',
                'bind_error': '绑定设备 {busid} 失败: {error}',
                'unbind_error': '解绑设备 {busid} 失败: {error}'
            }
        };

        function detectLang() {
            try {
                const stored = localStorage.getItem('usbctl_lang');
                if (stored && i18n[stored]) return stored;
                const nav = navigator.language || navigator.userLanguage || 'en';
                const langCode = nav.toLowerCase();
                if (langCode.startsWith('zh') || langCode.includes('chinese') || langCode.includes('cn'))
                    return 'zh';
                return 'en';
            } catch(e) {
                return 'en';
            }
        }

        function t(k, vars) {
            let text = i18n[lang][k] || k;
            if (vars) {
                Object.keys(vars).forEach(key => {
                    text = text.replace(`{${key}}`, vars[key]);
                });
            }
            return text;
        }

        function setLang(l) {
            lang = l;
            localStorage.setItem('usbctl_lang', l);
            updateUI();
        }

        function updateUI() {
            document.title = `usbctl - ${t('title')}`;
            document.querySelector('h1').textContent = t('title');
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
            
            const ths = document.querySelectorAll('th');
            if (ths.length >= 4) {
                ths[0].textContent = t('device');
                ths[1].textContent = t('busid');
                ths[2].textContent = t('status');
                ths[3].textContent = t('action');
            }

            document.querySelectorAll('.lang-btn').forEach(b =>
                b.classList.toggle('active', b.dataset.lang === lang)
            );

            const logTitle = document.querySelector('.log-title');
            if (logTitle) logTitle.textContent = t('log_title');

            const clearBtn = document.querySelector('.clear-log-btn');
            if (clearBtn) clearBtn.textContent = t('clear');

            render();
            renderLog();
        }

        function connectSSE() {
            if (eventSource) eventSource.close();
            
            eventSource = new EventSource('/events');
            
            eventSource.onopen = () => {
                document.getElementById('status').textContent = t('connected');
            };

            eventSource.onmessage = e => {
                try {
                    devices = JSON.parse(e.data);
                    render();
                } catch(err) {
                    console.error(err);
                }
            };

            eventSource.onerror = () => {
                document.getElementById('status').textContent = t('disconnected');
                setTimeout(connectSSE, 3000);
            };
        }

        function render() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = devices.map(d =>
                `<tr>
                    <td>${escapeHtml(d.info)}</td>
                    <td><code>${escapeHtml(d.busid)}</code></td>
                    <td><span class="status ${d.bound ? 'bound' : 'unbound'}">${t(d.bound ? 'bound' : 'unbound')}</span></td>
                    <td><button class="${d.bound ? 'btn-unbind' : 'btn-bind'}" onclick="toggle('${escapeHtml(d.busid)}')">${t(d.bound ? 'unbind' : 'bind')}</button></td>
                </tr>`
            ).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {type, message, timestamp};
            logEntries.unshift(entry);
            if (logEntries.length > 100) logEntries.pop();
            renderLog();
        }

        function renderLog() {
            const logContent = document.getElementById('logContent');
            if (!logContent) return;
            logContent.innerHTML = logEntries.map(entry =>
                `<div class="log-entry log-${entry.type}">
                    <span class="log-timestamp">[${entry.timestamp}]</span> ${escapeHtml(entry.message)}
                </div>`
            ).join('');
            logContent.scrollTop = 0;
        }

        function clearLog() {
            logEntries = [];
            renderLog();
        }

        function toggle(busid) {
            const device = devices.find(d => d.busid === busid);
            if (!device) return;

            const button = event.target;
            const action = device.bound ? 'unbind' : 'bind';
            button.disabled = true;

            fetch(`/${action}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({busid})
            })
            .then(response => {
                if (response.ok) {
                    return response.json().then(data => {
                        addLog('success', t(`${action}_success`, {busid}));
                        if (data.devices) {
                            devices = data.devices;
                            render();
                        }
                    });
                } else {
                    return response.json().then(data => {
                        const errorMsg = data.error || 'Unknown error';
                        addLog('error', t(`${action}_error`, {busid, error: errorMsg}));
                        throw new Error(errorMsg);
                    });
                }
            })
            .catch(err => {
                console.error(err);
            })
            .finally(() => button.disabled = false);
        }

        function loadDevices() {
            fetch('/api/devices')
                .then(r => r.json())
                .then(data => {
                    devices = data;
                    render();
                })
                .catch(console.error);
        }

        window.onload = () => {
            lang = detectLang();
            updateUI();
            connectSSE();
            loadDevices();
        };
    </script>
</body>
</html>